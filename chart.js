var price = {
    "1314": {
      "03/14": 12.05,
      "03/15": 11.9,
      "03/16": 11.95,
      "03/10": 12.1,
      "03/13": 11.9,
      "03/08": 12.75,
      "03/03": 11.9,
      "03/02": 11.7,
      "03/01": 11.95,
      "03/07": 12.65,
      "03/06": 11.95,
      "03/09": 12.4
    },
    "1512": {
      "03/14": 8,
      "03/15": 7.75,
      "03/16": 7.41,
      "03/10": 8.21,
      "03/13": 8.23,
      "03/08": 7.66,
      "03/03": 7.69,
      "03/02": 7.5,
      "03/01": 6.82,
      "03/07": 7.2,
      "03/06": 6.97,
      "03/09": 8
    },
    "2312": {
      "03/14": 12.2,
      "03/15": 12.2,
      "03/16": 12.2,
      "03/10": 12.3,
      "03/13": 12.2,
      "03/03": 12.5,
      "03/02": 12.5,
      "03/01": 12.55,
      "03/07": 12.35,
      "03/06": 12.4,
      "03/09": 12.35,
      "03/08": 12.3
    },
    "2313": {
      "03/14": 21.15,
      "03/15": 21.3,
      "03/16": 21.5,
      "03/10": 19.6,
      "03/13": 20.8,
      "03/08": 20.35,
      "03/03": 20.2,
      "03/02": 20,
      "03/01": 19.85,
      "03/07": 20.6,
      "03/06": 20.05,
      "03/09": 20
    },
    "2331": {
      "03/14": 23.4,
      "03/15": 24.05,
      "03/16": 23.7,
      "03/10": 24.6,
      "03/13": 24.55,
      "03/08": 24.95,
      "03/03": 23.05,
      "03/02": 23.1,
      "03/01": 22.95,
      "03/07": 24.6,
      "03/06": 23.2,
      "03/09": 25
    },
    "2332": {
      "03/14": 11.6,
      "03/15": 12.25,
      "03/16": 12.1,
      "03/10": 11.45,
      "03/13": 11.5,
      "03/08": 11.85,
      "03/03": 11.65,
      "03/02": 11.95,
      "03/01": 12.45,
      "03/07": 11.85,
      "03/06": 11.8,
      "03/09": 11.7
    },
    "2337": {
      "03/14": 9.1,
      "03/15": 9.35,
      "03/16": 9.6,
      "03/10": 8.52,
      "03/13": 8.83,
      "03/08": 9.03,
      "03/03": 9.66,
      "03/02": 9.79,
      "03/01": 9.85,
      "03/07": 9,
      "03/06": 10,
      "03/09": 8.8
    },
    "2367": {
      "03/14": 11.45,
      "03/15": 11.45,
      "03/16": 11.35,
      "03/10": 11.35,
      "03/13": 11.45,
      "03/08": 11.15,
      "03/03": 11.05,
      "03/02": 11.1,
      "03/01": 11.3,
      "03/07": 10.95,
      "03/06": 10.95,
      "03/09": 11.3
    },
    "2383": {
      "03/14": 127,
      "03/15": 126,
      "03/16": 125,
      "03/10": 117.5,
      "03/13": 128,
      "03/08": 118.5,
      "03/03": 110.5,
      "03/02": 110,
      "03/01": 109.5,
      "03/07": 117.5,
      "03/06": 110,
      "03/09": 116.5
    },
    "2439": {
      "03/14": 149,
      "03/15": 149.5,
      "03/16": 150.5,
      "03/10": 147,
      "03/13": 151.5,
      "03/03": 142,
      "03/02": 141,
      "03/01": 140,
      "03/07": 145,
      "03/06": 144.5,
      "03/09": 147.5,
      "03/08": 146
    },
    "2449": {
      "03/14": 27.65,
      "03/15": 27.75,
      "03/16": 27.7,
      "03/10": 27.25,
      "03/13": 27.7,
      "03/08": 28.05,
      "03/03": 27.6,
      "03/02": 28.3,
      "03/01": 28.7,
      "03/07": 27.55,
      "03/06": 27.65,
      "03/09": 27.6
    },
    "2451": {
      "03/14": 97.1,
      "03/15": 97,
      "03/16": 97.2,
      "03/10": 89.5,
      "03/13": 93.1,
      "03/08": 87.6,
      "03/03": 86,
      "03/02": 85.9,
      "03/01": 86.4,
      "03/07": 87.7,
      "03/06": 86.9,
      "03/09": 87.7
    },
    "2480": {
      "03/14": 32.45,
      "03/15": 32.35,
      "03/16": 32.45,
      "03/10": 31.9,
      "03/13": 32.05,
      "03/08": 32.45,
      "03/03": 31.2,
      "03/02": 31.2,
      "03/01": 31.5,
      "03/07": 32.85,
      "03/06": 32.6,
      "03/09": 32.2
    },
    "2492": {
      "03/14": 46.65,
      "03/15": 46.85,
      "03/16": 47.45,
      "03/10": 46,
      "03/13": 47.35,
      "03/08": 47,
      "03/03": 45.5,
      "03/02": 46.4,
      "03/01": 47.4,
      "03/07": 47.55,
      "03/06": 47.8,
      "03/09": 47.3
    },
    "2603": {
      "03/14": 14.6,
      "03/15": 14.5,
      "03/16": 14.65,
      "03/10": 14.45,
      "03/13": 14.65,
      "03/08": 14.9,
      "03/03": 15.15,
      "03/02": 15.3,
      "03/01": 15,
      "03/07": 15,
      "03/06": 15.05,
      "03/09": 14.95
    },
    "2606": {
      "03/14": 32.5,
      "03/15": 31.75,
      "03/16": 31.95,
      "03/10": 32.8,
      "03/13": 32.25,
      "03/08": 34.15,
      "03/03": 32.7,
      "03/02": 33,
      "03/01": 33.6,
      "03/07": 33.3,
      "03/06": 32.7,
      "03/09": 34
    },
    "2609": {
      "03/14": 7.13,
      "03/15": 7.16,
      "03/16": 7.19,
      "03/10": 7.19,
      "03/13": 7.21,
      "03/03": 7.33,
      "03/02": 7.42,
      "03/01": 7.36,
      "03/07": 7.35,
      "03/06": 7.4,
      "03/09": 7.38,
      "03/08": 7.47
    },
    "2615": {
      "03/14": 18.25,
      "03/15": 17.95,
      "03/16": 18.05,
      "03/10": 18.25,
      "03/13": 18.1,
      "03/08": 19,
      "03/03": 18.65,
      "03/02": 19,
      "03/01": 19.15,
      "03/07": 18.85,
      "03/06": 18.65,
      "03/09": 18.5
    },
    "2633": {
      "03/14": 20.85,
      "03/15": 20.85,
      "03/16": 21.25,
      "03/10": 21.1,
      "03/13": 20.85,
      "03/08": 21.05,
      "03/03": 21.15,
      "03/02": 21,
      "03/01": 21.4,
      "03/07": 21.1,
      "03/06": 21.25,
      "03/09": 21.15
    },
    "2809": {
      "03/14": 30.3,
      "03/15": 30.1,
      "03/16": 30.2,
      "03/10": 29.55,
      "03/13": 30.5,
      "03/08": 29.6,
      "03/03": 28.95,
      "03/02": 29.1,
      "03/01": 28.8,
      "03/07": 29.05,
      "03/06": 29,
      "03/09": 29.25
    },
    "2820": {
      "03/14": 13.95,
      "03/15": 13.9,
      "03/16": 13.95,
      "03/10": 13.95,
      "03/13": 13.9,
      "03/08": 13.9,
      "03/03": 13.9,
      "03/02": 13.9,
      "03/01": 13.9,
      "03/07": 13.95,
      "03/06": 13.95,
      "03/09": 13.95
    },
    "2887": {
      "03/14": 12.2,
      "03/15": 12.2,
      "03/16": 12.2,
      "03/10": 12.1,
      "03/13": 12.15,
      "03/08": 12.1,
      "03/03": 12.05,
      "03/02": 12.1,
      "03/01": 12,
      "03/07": 12.1,
      "03/06": 12.1,
      "03/09": 12.05
    },
    "2891": {
      "03/14": 18.65,
      "03/15": 18.9,
      "03/16": 18.95,
      "03/10": 18.7,
      "03/13": 18.8,
      "03/08": 18.6,
      "03/03": 18.5,
      "03/02": 18.55,
      "03/01": 18.4,
      "03/07": 18.55,
      "03/06": 18.55,
      "03/09": 18.6
    },
    "2892": {
      "03/14": 18.6,
      "03/15": 18.6,
      "03/16": 18.7,
      "03/10": 18.25,
      "03/13": 18.4,
      "03/08": 18.2,
      "03/03": 18.2,
      "03/02": 18.2,
      "03/01": 18.15,
      "03/07": 18.2,
      "03/06": 18.2,
      "03/09": 18.3
    },
    "3105": {
      "03/14": 122.5,
      "03/15": 125,
      "03/16": 126,
      "03/10": 120,
      "03/13": 121.5,
      "03/08": 127.5,
      "03/03": 125,
      "03/02": 123.5,
      "03/01": 121,
      "03/07": 129.5,
      "03/06": 123.5,
      "03/09": 125.5
    },
    "3268": {
      "03/14": 15,
      "03/15": 15.3,
      "03/16": 15.85,
      "03/10": 14.75,
      "03/13": 14.45,
      "03/03": 14.15,
      "03/02": 14.55,
      "03/01": 15.05,
      "03/07": 14.35,
      "03/06": 14.5,
      "03/09": 14.85,
      "03/08": 14.65
    },
    "3380": {
      "03/14": 23.25,
      "03/15": 23.6,
      "03/16": 24.2,
      "03/10": 20.75,
      "03/13": 21.15,
      "03/08": 21.5,
      "03/03": 21,
      "03/02": 20.95,
      "03/01": 21.15,
      "03/07": 21.1,
      "03/06": 20.9,
      "03/09": 21.05
    },
    "3443": {
      "03/14": 111.5,
      "03/15": 108.5,
      "03/16": 109,
      "03/10": 110,
      "03/13": 105,
      "03/08": 109,
      "03/03": 106,
      "03/02": 104.5,
      "03/01": 102,
      "03/07": 109,
      "03/06": 107.5,
      "03/09": 111.5
    },
    "3515": {
      "03/14": 42,
      "03/15": 41.85,
      "03/16": 42.1,
      "03/10": 43.8,
      "03/13": 42.9,
      "03/08": 44.15,
      "03/03": 42.1,
      "03/02": 42.35,
      "03/01": 42,
      "03/07": 44.8,
      "03/06": 43.3,
      "03/09": 44.3
    },
    "3537": {
      "03/14": 22.1,
      "03/15": 22.1,
      "03/16": 22.1,
      "03/10": 21.8,
      "03/13": 21.85,
      "03/08": 21.7,
      "03/03": 21.75,
      "03/02": 21.7,
      "03/01": 22,
      "03/07": 21.7,
      "03/06": 21.95,
      "03/09": 22.5
    },
    "3680": {
      "03/14": 36.7,
      "03/15": 36,
      "03/16": 35.85,
      "03/10": 36.35,
      "03/13": 36.6,
      "03/03": 36.3,
      "03/02": 36.3,
      "03/01": 37.55,
      "03/07": 35.45,
      "03/06": 35.45,
      "03/09": 37.8,
      "03/08": 36.75
    },
    "3706": {
      "03/14": 33.1,
      "03/15": 32.8,
      "03/16": 32.85,
      "03/10": 32.4,
      "03/13": 32.3,
      "03/08": 32.7,
      "03/03": 32.55,
      "03/02": 32.1,
      "03/01": 32.2,
      "03/07": 32.9,
      "03/06": 33.3,
      "03/09": 32.65
    },
    "4532": {
      "03/14": 34.2,
      "03/15": 34.45,
      "03/16": 34.2,
      "03/10": 33.7,
      "03/13": 33.6,
      "03/08": 34.2,
      "03/03": 35.4,
      "03/02": 34.95,
      "03/01": 35.3,
      "03/07": 34.65,
      "03/06": 34.55,
      "03/09": 34.55
    },
    "4739": {
      "03/14": 55.6,
      "03/15": 55.6,
      "03/16": 55,
      "03/10": 55.1,
      "03/13": 55.6,
      "03/08": 58,
      "03/03": 57.5,
      "03/02": 52.9,
      "03/01": 53.3,
      "03/07": 58.5,
      "03/06": 55.3,
      "03/09": 57
    },
    "4979": {
      "03/14": 43.1,
      "03/15": 41.3,
      "03/16": 42.35,
      "03/10": 37.6,
      "03/13": 39.2,
      "03/03": 36.55,
      "03/02": 36.2,
      "03/01": 36.6,
      "03/07": 36.5,
      "03/06": 36.1,
      "03/09": 37.6,
      "03/08": 37.2
    },
    "5230": {
      "03/14": 42.8,
      "03/15": 45,
      "03/16": 45.25,
      "03/10": 43.7,
      "03/13": 43.2,
      "03/08": 42.9,
      "03/03": 42.7,
      "03/02": 42.7,
      "03/01": 42.9,
      "03/07": 42.2,
      "03/06": 42.2,
      "03/09": 43.5
    },
    "5609": {
      "03/14": 21.7,
      "03/15": 21.6,
      "03/16": 23.15,
      "03/10": 21.05,
      "03/13": 21.15,
      "03/08": 21.45,
      "03/03": 21.5,
      "03/02": 21.45,
      "03/01": 21.45,
      "03/07": 21.5,
      "03/06": 21.4,
      "03/09": 21.35
    },
    "6138": {
      "03/14": 44.2,
      "03/15": 43.1,
      "03/16": 43.25,
      "03/10": 40.95,
      "03/13": 45,
      "03/08": 39.2,
      "03/03": 36.6,
      "03/02": 37.8,
      "03/01": 37.15,
      "03/07": 38.15,
      "03/06": 36.15,
      "03/09": 43.05
    },
    "6191": {
      "03/14": 12.9,
      "03/15": 13.05,
      "03/16": 13.2,
      "03/10": 12.75,
      "03/13": 12.85,
      "03/08": 13,
      "03/03": 12.65,
      "03/02": 12.65,
      "03/01": 12.8,
      "03/07": 12.95,
      "03/06": 12.75,
      "03/09": 12.9
    },
    "6202": {
      "03/14": 55.1,
      "03/15": 55.3,
      "03/16": 55.2,
      "03/10": 54.5,
      "03/13": 54.4,
      "03/08": 54.1,
      "03/03": 54,
      "03/02": 53.6,
      "03/01": 53.3,
      "03/07": 54.3,
      "03/06": 54.6,
      "03/09": 54.2
    },
    "6213": {
      "03/14": 44.8,
      "03/15": 44.05,
      "03/16": 44.85,
      "03/10": 43.85,
      "03/13": 45.1,
      "03/08": 43.3,
      "03/03": 40.85,
      "03/02": 40.45,
      "03/01": 41.05,
      "03/07": 41.95,
      "03/06": 41.75,
      "03/09": 43.1
    },
    "6274": {
      "03/14": 46.9,
      "03/15": 46.65,
      "03/16": 46.1,
      "03/10": 44.05,
      "03/13": 47.85,
      "03/08": 43.9,
      "03/03": 41.5,
      "03/02": 41.6,
      "03/01": 40.9,
      "03/07": 42.4,
      "03/06": 42.95,
      "03/09": 43.6
    },
    "8049": {
      "03/14": 16.35,
      "03/15": 16.15,
      "03/16": 16.1,
      "03/10": 15.85,
      "03/13": 16,
      "03/08": 15.9,
      "03/03": 15.9,
      "03/02": 15.85,
      "03/01": 15.85,
      "03/07": 15.6,
      "03/06": 15.7,
      "03/09": 15.85
    },
    "8050": {
      "03/14": 63,
      "03/15": 64.5,
      "03/16": 64.7,
      "03/10": 63.1,
      "03/13": 62.6,
      "03/08": 63.6,
      "03/03": 64.1,
      "03/02": 64.2,
      "03/01": 64.5,
      "03/07": 63.7,
      "03/06": 63.6,
      "03/09": 63.9
    },
    "8147": {
      "03/14": 38.45,
      "03/15": 38.7,
      "03/16": 38.7,
      "03/10": 38.7,
      "03/13": 38.4,
      "03/08": 38.4,
      "03/03": 38.2,
      "03/02": 38.5,
      "03/01": 38.7,
      "03/07": 38.2,
      "03/06": 38,
      "03/09": 38.5
    },
    "8404": {
      "03/14": 38.85,
      "03/15": 38.7,
      "03/16": 38.95,
      "03/10": 38,
      "03/13": 39.2,
      "03/03": 37.5,
      "03/02": 37.2,
      "03/01": 37.2,
      "03/07": 37.3,
      "03/06": 37.1,
      "03/09": 37.15,
      "03/08": 37.1
    },
    "8418": {
      "03/14": 13.7,
      "03/15": 13.45,
      "03/16": 13.6,
      "03/10": 13.65,
      "03/13": 13.5,
      "03/03": 12.9,
      "03/02": 12.85,
      "03/01": 12.2,
      "03/07": 13,
      "03/06": 12.85,
      "03/09": 13.75,
      "03/08": 13.5
    },
    "9907": {
      "03/14": 15.3,
      "03/15": 15.35,
      "03/16": 15.35,
      "03/10": 15.15,
      "03/13": 15.2,
      "03/08": 15.6,
      "03/03": 15.2,
      "03/02": 15.2,
      "03/01": 15.2,
      "03/07": 15.3,
      "03/06": 15.25,
      "03/09": 15.5
    },
    "9945": {
      "03/14": 38.95,
      "03/15": 38.95,
      "03/16": 39,
      "03/10": 38.6,
      "03/13": 38.65,
      "03/08": 38.9,
      "03/03": 38.85,
      "03/02": 38.4,
      "03/01": 38.9,
      "03/07": 38.9,
      "03/06": 39.1,
      "03/09": 38.6
    },
    "728012": {
      "03/14": 0.63,
      "03/15": 0.63,
      "03/16": 0.69,
      "03/10": 0.73,
      "03/13": 0.62,
      "03/03": 0.74,
      "03/02": 0.68,
      "03/01": 0.6,
      "03/07": 0.79,
      "03/06": 0.77,
      "03/09": 0.75,
      "03/08": 0.76
    },
    "KY8418": {
      
    },
    "2887E": {
      "03/14": 52.5,
      "03/15": 52.6,
      "03/16": 52.5,
      "03/10": 52.8,
      "03/13": 52.7,
      "03/03": 53.2,
      "03/02": 53,
      "03/01": 52.6,
      "03/07": 53.1,
      "03/06": 53.2,
      "03/09": 52.7,
      "03/08": 52.8
    },
    "00642U": {
      "03/14": 17.47,
      "03/15": 17.47,
      "03/16": 17.59,
      "03/10": 17.84,
      "03/13": 17.36,
      "03/08": 18.83,
      "03/03": 18.75,
      "03/02": 18.96,
      "03/01": 19.07,
      "03/07": 18.92,
      "03/06": 18.83,
      "03/09": 18.22
    }
  };

var records = [
    {
        "date": "03/01 09:00:25",
        "name": "家登3680",
        "type": "買",
        "share": 2000,
        "price": 36.5,
        "total": 73000
    },
    {
        "date": "03/01 09:02:26",
        "name": "家登3680",
        "type": "買",
        "share": 1000,
        "price": 36.2,
        "total": 36200
    },
    {
        "date": "03/01 09:06:50",
        "name": "康普4739",
        "type": "買",
        "share": 1000,
        "price": 54.8,
        "total": 54800
    },
    {
        "date": "03/01 09:12:21",
        "name": "友訊2332",
        "type": "買",
        "share": 1000,
        "price": 11.95,
        "total": 11950
    },
    {
        "date": "03/01 11:03:48",
        "name": "華擎3515",
        "type": "買",
        "share": 1000,
        "price": 42,
        "total": 42000
    },
    {
        "date": "03/01 11:57:54",
        "name": "瑞智4532",
        "type": "買",
        "share": 1000,
        "price": 35.1,
        "total": 35100
    },
    {
        "date": "03/01 12:04:55",
        "name": "盛群6202",
        "type": "買",
        "share": 1000,
        "price": 53.8,
        "total": 53800
    },
    {
        "date": "03/02 12:33:53",
        "name": "正淩8147",
        "type": "買",
        "share": 1000,
        "price": 38.55,
        "total": 38550
    },
    {
        "date": "03/02 12:53:24",
        "name": "堡達3537",
        "type": "買",
        "share": 1000,
        "price": 22.05,
        "total": 22050
    },
    {
        "date": "03/03 12:54:45",
        "name": "堡達3537",
        "type": "買",
        "share": 1000,
        "price": 22.05,
        "total": 22050
    },
    {
        "date": "03/07 09:00:25",
        "name": "家登3680",
        "type": "賣",
        "share": 1000,
        "price": 38.5,
        "total": 38500
    },
    {
        "date": "03/07 09:10:25",
        "name": "家登3680",
        "type": "賣",
        "share": 2000,
        "price": 39,
        "total": 78000
    },
];

  var base = 0;
  var gain = 0;
  var total = 0;
  var stocks = {};
  var points = {};

  var dates = Object.keys(price['1314']).sort();
  for (var i in dates) records.push({ 'date': dates[i] + ' 14:00:00' });
  records = records.sort(function (a, b) { return (a.date < b.date)? -1: 1; });

  for (var i in records) {
    var r = records[i];
    if (r.type) {
      var id = /[0-9][0-9A-Z]+$/.exec(r.name)[0];
      if (!stocks[id]) stocks[id] = [];
      var stock = stocks[id];
      if (r.type == '賣') {
        total -= r.total;
        var cost = 0;
        var left = r.share;
        for (var j in stock) {
          var s = stock[j];
          if (s.share >= left) {
            cost += left * s.price;
            s.share -= left;
            break;
          }
          cost += s.share * s.price;
          left -= s.share;
          s.share = 0;
        }
        r.gain = r.total - cost;
        gain += r.gain;
      }
      else { //買
        total += r.total;
        if (total > base) base = total;
        stocks[id].push({price: r.price, share: r.share})
      }
    }
    var p = {};
    p.date = r.date.toString().substr(0, 5);
    p.value = 0;
    p.price = 0;
    for (var k in stocks) {
        var stock = stocks[k];
        for (var j in stock) {
            var s = stock[j];
            p.value += s.share * price[k][p.date];
            p.price += s.share * s.price;
        }
    }
    p.rate = Math.round((gain + p.value - p.price) / base * 1000) / 10.0;
    p.price = p.price / 1000;
    p.value = p.value / 1000;
    p.base = base / 1000;
    p.gain = gain / 1000;
    points[p.date] = p;
  }
  var arr = [];
  var dates = Object.keys(points).sort();
  for (var i in dates) arr.push(points[dates[i]]);
  console.log(arr);
